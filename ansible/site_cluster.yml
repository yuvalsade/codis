---
- hosts: all
  gather_facts: True
  tasks:
  - name: add redis group
    group:
        name: redis
        state: present
  - name: add redis user 
    user:
        name: redis
        state: present
        append: yes
        group: redis
        createhome: yes

- name: set base facts
  hosts: redis
  tasks:
  - set_fact:
      redis_interface: "{{ ansible_default_ipv4.address }}"
      #redis_bind: "{{ ansible_default_ipv4.address }}"
      redis_bind1: 0.0.0.0
      redis_port: 6379
      redis_user: redis
      twemproxy_stats_addr: "{{ ansible_default_ipv4.address }}"

- name: install redis
  hosts: redis
  roles:
    - redis-cluster

 
- name: join nodes
  hosts: redis[0]
  tasks:
    - command: "redis-cli -h {{ ansible_default_ipv4.address }} -p {{ redis_port}} CLUSTER MEET {{ hostvars[item].ansible_default_ipv4.address }} {{ hostvars[item].redis_port }}  "
      name: Exec redis-cli
      with_items: "{{ groups.redis[1:] }}"

- name: create slots
  hosts: redis[0]
  tasks:
    - command: "redis-cli -h {{ ansible_default_ipv4.address }} -p {{ redis_port}} cluster info | grep cluster_slots_assigned: | awk -F':' '{print $2}'"
      name: count slots
      register: slots

    - command: "for slot in {0..16383}; do redis-cli -h {{ ansible_default_ipv4.address }} -p {{ redis_port}} CLUSTER ADDSLOTS $slot ; done;"
      name: Exec redis-cli add slots
      when: slots.stdout != "16384"
      

